<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Compare Models — Arabic ITSM</title>
  <link rel="stylesheet" href="/static/common.css">
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
  <style>
    .compare-meta { color: var(--text-muted); font-size: 0.8125rem; margin-bottom: 1rem; direction: ltr; text-align: left; }
    .samples { display: flex; gap: 0.5rem; flex-wrap: wrap; margin-bottom: 1rem; }
    .sample {
      border: 1px solid var(--border);
      background: var(--bg-elevated);
      color: var(--text-secondary);
      border-radius: 999px;
      padding: 0.4rem 0.75rem;
      font-size: 0.8125rem;
      cursor: pointer;
      transition: background 0.15s, border-color 0.15s;
    }
    .sample:hover { background: var(--surface); border-color: var(--text-muted); }
    .submit-btn { width: 100%; padding: 0.75rem; margin-top: 0.5rem; }
    .error-box {
      margin-top: 1rem;
      padding: 0.75rem 1rem;
      background: var(--error-bg);
      color: var(--error-text);
      border-radius: var(--radius-sm);
      font-size: 0.875rem;
      display: none;
    }
    /* Model status panel */
    .models-status {
      margin-bottom: 1rem;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      overflow: hidden;
    }
    .models-status-header {
      padding: 0.625rem 1rem;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-muted);
      border-bottom: 1px solid var(--border);
      direction: ltr;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .model-status-row {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.5rem 1rem;
      border-bottom: 1px solid var(--border-subtle);
      direction: ltr;
    }
    .model-status-row:last-child { border-bottom: none; }
    .model-status-name { font-size: 0.8125rem; font-weight: 500; flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .model-status-bar { flex: 0 0 80px; }
    .model-status-msg { font-size: 0.72rem; color: var(--text-muted); flex: 0 0 auto; max-width: 140px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    /* Results */
    .results-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 1rem;
      margin-top: 1.5rem;
    }
    .model-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 1.25rem;
      box-shadow: var(--shadow);
      transition: border-color 0.15s, box-shadow 0.15s;
    }
    .model-card:hover { border-color: var(--text-muted); box-shadow: var(--shadow-md); }
    .model-card h3 { font-size: 1rem; font-weight: 600; margin-bottom: 0.25rem; }
    .model-id { color: var(--text-muted); font-size: 0.75rem; margin-bottom: 1rem; direction: ltr; text-align: left; }
    .task { margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px dashed var(--border); }
    .task-name { font-size: 0.6875rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em; direction: ltr; text-align: left; margin-bottom: 0.25rem; }
    .task-label { font-weight: 600; font-size: 0.9375rem; direction: ltr; text-align: left; }
    .task-conf { font-size: 0.75rem; color: var(--text-muted); direction: ltr; text-align: left; margin-top: 0.2rem; }
    .task-bar { height: 6px; background: var(--border); border-radius: 999px; overflow: hidden; margin-top: 0.35rem; }
    .task-fill { height: 100%; background: var(--accent); border-radius: 999px; }
  </style>
</head>
<body>
  <div class="page-wide" style="padding-top: 2rem;">
    <header class="header">
      <div class="header-brand">
        <h1>Compare Models</h1>
        <p>Run one ticket across all configured models.</p>
      </div>
      <div class="header-actions">
        <a class="btn nav-link" href="/models">
          <i data-lucide="layout-grid" style="width:16px;height:16px;"></i>
          Catalog
        </a>
        <button class="btn-icon" id="themeBtn" type="button" aria-label="Toggle theme">
          <i data-lucide="moon" class="icon-dark" style="width:18px;height:18px;"></i>
          <i data-lucide="sun" class="icon-light hidden" style="width:18px;height:18px;"></i>
        </button>
      </div>
    </header>

    <!-- Per-model loading status panel -->
    <div class="models-status" id="modelsStatus" style="display:none;">
      <div class="models-status-header">
        <span>Model Status</span>
        <span id="statusSummary"></span>
      </div>
      <div id="statusRows"></div>
    </div>

    <section class="card">
      <div class="samples" id="samples"></div>
      <div class="form-group">
        <label class="form-label" for="title_ar">عنوان التذكرة</label>
        <input id="title_ar" type="text" class="form-input" placeholder="مثال: الـ VPN مش شغال">
      </div>
      <div class="form-group">
        <label class="form-label" for="description_ar">وصف المشكلة</label>
        <textarea id="description_ar" class="form-textarea" placeholder="اكتب التفاصيل هنا"></textarea>
      </div>
      <button class="btn btn-primary submit-btn" id="btn">
        <i data-lucide="git-compare" style="width:18px;height:18px;"></i>
        تصنيف بكل النماذج
      </button>
      <div class="error-box" id="error"></div>
    </section>

    <section class="results-grid" id="results"></section>
  </div>

  <script>
    (function() {
      const root = document.documentElement;
      const saved = localStorage.getItem('theme') || 'light';
      root.setAttribute('data-theme', saved);
    })();

    document.getElementById('themeBtn').addEventListener('click', () => {
      const root = document.documentElement;
      const next = root.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
      root.setAttribute('data-theme', next);
      localStorage.setItem('theme', next);
      document.querySelector('.icon-dark').classList.toggle('hidden', next === 'dark');
      document.querySelector('.icon-light').classList.toggle('hidden', next === 'light');
      lucide.createIcons();
    });

    lucide.createIcons();

    const samplesEl = document.getElementById('samples');
    const resultsEl = document.getElementById('results');
    const errEl = document.getElementById('error');
    const btn = document.getElementById('btn');
    const modelsStatus = document.getElementById('modelsStatus');
    const statusRows = document.getElementById('statusRows');
    const statusSummary = document.getElementById('statusSummary');

    let _models = [];
    let _pollTimer = null;

    const sampleTickets = [
      { title: 'الـ VPN مش شغال', description: 'اليوزر مش قادر يدخل على الشبكة الداخلية من البيت.' },
      { title: 'نسيت باسورد الإيميل', description: 'محتاج reset لحساب Outlook بشكل عاجل.' },
      { title: 'الطابعة في الدور الثالث واقفة', description: 'بتظهر رسالة paper jam ومش بتطبع أي مستند.' },
      { title: 'الجهاز بطيء جدا بعد آخر تحديث', description: 'البرامج بتفتح ببطء والجهاز بيهنج بشكل متكرر.' }
    ];

    function showError(msg) { errEl.style.display = 'block'; errEl.textContent = msg; }
    function clearError() { errEl.style.display = 'none'; errEl.textContent = ''; }

    function modelStatusBadge(m) {
      if (m.status === 'ready' || m.loaded)
        return '<span class="badge badge-success" style="font-size:0.7rem;padding:0.15rem 0.5rem;">Ready</span>';
      if (m.status === 'loading')
        return `<span class="badge badge-warning" style="font-size:0.7rem;padding:0.15rem 0.5rem;"><div class="spinner" style="width:8px;height:8px;border-width:1.5px;display:inline-block;vertical-align:-2px;margin-right:3px;"></div>${m.progress || 0}%</span>`;
      if (m.status === 'error')
        return '<span class="badge badge-error" style="font-size:0.7rem;padding:0.15rem 0.5rem;">Error</span>';
      return '<span class="badge" style="font-size:0.7rem;padding:0.15rem 0.5rem;background:var(--info-bg);color:var(--info-text);border:none;">Cold</span>';
    }

    function renderStatusRows(models) {
      if (!models.length) { modelsStatus.style.display = 'none'; return; }
      modelsStatus.style.display = 'block';
      const ready = models.filter(m => m.status === 'ready' || m.loaded).length;
      statusSummary.textContent = `${ready}/${models.length} ready`;
      statusRows.innerHTML = models.map(m => `
        <div class="model-status-row" data-status-id="${m.id}">
          ${modelStatusBadge(m)}
          <span class="model-status-name" title="${m.id}">${m.name}</span>
          <div class="model-status-bar">
            <div class="progress-bar" style="margin-top:0;"><div class="progress-fill" style="width:${m.progress || 0}%"></div></div>
          </div>
          <span class="model-status-msg">${m.status === 'loading' ? (m.message || 'Loading...') : ''}</span>
        </div>
      `).join('');
      lucide.createIcons();
    }

    function updateStatusRow(m) {
      const row = statusRows.querySelector(`[data-status-id="${m.id}"]`);
      if (!row) return;
      const badgeWrap = row.querySelector('.badge, .badge-success, .badge-warning, .badge-error');
      if (badgeWrap) badgeWrap.outerHTML = modelStatusBadge(m);
      const fill = row.querySelector('.progress-fill');
      if (fill) fill.style.width = `${m.progress || 0}%`;
      const msg = row.querySelector('.model-status-msg');
      if (msg) msg.textContent = m.status === 'loading' ? (m.message || 'Loading...') : '';
      const ready = _models.filter(x => x.status === 'ready' || x.loaded).length;
      statusSummary.textContent = `${ready}/${_models.length} ready`;
    }

    function renderSamples() {
      samplesEl.innerHTML = sampleTickets
        .map((item, i) => `<button class="sample" type="button" data-index="${i}">${item.title}</button>`)
        .join('');
      samplesEl.addEventListener('click', (e) => {
        const chip = e.target.closest('.sample');
        if (!chip) return;
        const sample = sampleTickets[Number(chip.dataset.index)];
        if (!sample) return;
        document.getElementById('title_ar').value = sample.title;
        document.getElementById('description_ar').value = sample.description;
      });
    }

    function renderTask(taskName, payload) {
      const conf = Number(payload.confidence || 0);
      return `
        <div class="task">
          <div class="task-name">${taskName}</div>
          <div class="task-label">${payload.label}</div>
          <div class="task-conf">${(conf * 100).toFixed(2)}%</div>
          <div class="task-bar"><div class="task-fill" style="width:${(conf * 100).toFixed(2)}%"></div></div>
        </div>
      `;
    }

    function renderModel(result) {
      const tasks = result.tasks || [];
      return `
        <article class="model-card">
          <h3>${result.model_id}</h3>
          <div class="model-id"><i data-lucide="timer" style="width:12px;height:12px;vertical-align:-2px;"></i> ${result.latency_ms} ms</div>
          ${tasks.map(t => renderTask(t, result[t])).join('')}
        </article>
      `;
    }

    async function fetchModels() {
      const res = await fetch('/api/models');
      const data = await res.json();
      _models = data.models || [];
      return _models;
    }

    function stopPolling() {
      if (_pollTimer) { clearInterval(_pollTimer); _pollTimer = null; }
    }

    function startStatusPolling(onAllReady) {
      stopPolling();
      _pollTimer = setInterval(async () => {
        const models = await fetchModels();
        models.forEach(updateStatusRow);
        const anyLoading = models.some(m => m.status === 'loading');
        const allReady = models.every(m => m.status === 'ready' || m.loaded);
        if (!anyLoading) {
          stopPolling();
          renderStatusRows(models);
          if (allReady && onAllReady) onAllReady();
        }
      }, 900);
    }

    async function preloadAll() {
      for (const m of _models) {
        if (m.status !== 'ready' && !m.loaded) {
          await fetch(`/api/models/${encodeURIComponent(m.id)}/preload`, { method: 'POST' });
        }
      }
    }

    async function classifyAll() {
      clearError();
      const titleAr = document.getElementById('title_ar').value.trim();
      const descriptionAr = document.getElementById('description_ar').value.trim();
      if (!titleAr) { showError('عنوان التذكرة مطلوب'); return; }

      btn.disabled = true;
      resultsEl.innerHTML = '';

      // Check if any models need loading first
      await fetchModels();
      const coldModels = _models.filter(m => m.status !== 'ready' && !m.loaded);

      if (coldModels.length > 0) {
        // Phase 1: preload cold models with live progress
        btn.innerHTML = `<div class="spinner"></div> تحميل النماذج (${coldModels.length} متبقي)...`;
        renderStatusRows(_models);
        await preloadAll();
        // Poll until all ready, then run classify
        await new Promise((resolve) => {
          startStatusPolling(() => resolve());
          // Also update button text during loading
          const btnInterval = setInterval(async () => {
            const ready = _models.filter(m => m.status === 'ready' || m.loaded).length;
            const loading = _models.filter(m => m.status === 'loading').length;
            if (loading === 0) { clearInterval(btnInterval); return; }
            btn.innerHTML = `<div class="spinner"></div> تحميل النماذج (${ready}/${_models.length} جاهز)...`;
          }, 500);
        });
      }

      // Phase 2: run classification across all loaded models
      btn.innerHTML = '<div class="spinner"></div> جاري التصنيف...';
      try {
        const res = await fetch('/api/classify/all', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ title_ar: titleAr, description_ar: descriptionAr })
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.detail || `HTTP ${res.status}`);
        resultsEl.innerHTML = (data.results || []).map(renderModel).join('');
        lucide.createIcons();
        // Refresh status panel after classify (models are now loaded)
        await fetchModels();
        renderStatusRows(_models);
      } catch (err) {
        showError(err.message);
      } finally {
        btn.disabled = false;
        btn.innerHTML = '<i data-lucide="git-compare" style="width:18px;height:18px;"></i> تصنيف بكل النماذج';
        lucide.createIcons();
      }
    }

    btn.addEventListener('click', classifyAll);
    document.getElementById('title_ar').addEventListener('keydown', e => { if (e.key === 'Enter') classifyAll(); });

    renderSamples();
    fetchModels().then(models => {
      renderStatusRows(models);
      if (models.some(m => m.status === 'loading')) startStatusPolling(null);
    }).catch(err => showError(err.message));

    document.querySelector('.icon-dark').classList.toggle('hidden', document.documentElement.getAttribute('data-theme') === 'dark');
    document.querySelector('.icon-light').classList.toggle('hidden', document.documentElement.getAttribute('data-theme') === 'light');
  </script>
</body>
</html>
