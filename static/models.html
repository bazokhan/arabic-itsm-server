<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Model Catalog — Arabic ITSM</title>
  <link rel="stylesheet" href="/static/common.css">
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
  <style>
    .meta { color: var(--text-muted); font-size: 0.875rem; margin-bottom: 1.5rem; }
    .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1rem; }
    .model-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 1.25rem;
      box-shadow: var(--shadow);
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      transition: border-color 0.15s, box-shadow 0.15s;
    }
    .model-card:hover { border-color: var(--text-muted); box-shadow: var(--shadow-md); }
    .model-card-head { display: flex; justify-content: space-between; align-items: flex-start; gap: 0.5rem; }
    .model-title { font-weight: 600; font-size: 1rem; }
    .model-id { color: var(--text-muted); font-size: 0.75rem; font-family: ui-monospace, monospace; }
    .model-path { color: var(--text-muted); font-size: 0.75rem; word-break: break-all; line-height: 1.4; }
    .model-card .btn { margin-top: auto; }
    .empty-card {
      background: var(--surface);
      border: 1px dashed var(--border);
      border-radius: var(--radius);
      padding: 2rem;
      text-align: center;
      color: var(--text-muted);
      font-size: 0.9375rem;
    }
    .nav-link { display: inline-flex; align-items: center; gap: 0.35rem; }
  </style>
</head>
<body>
  <div class="page-wide" style="padding-top: 2rem;">
    <header class="header">
      <div class="header-brand">
        <h1>Model Catalog</h1>
        <p><strong>Classifier</strong> uses the default model. <strong>Compare</strong> runs across all models. Set <code>DEFAULT_MODEL_ID</code> in .env to change the default.</p>
      </div>
      <div class="header-actions">
        <a class="btn nav-link" href="/classify">
          <i data-lucide="sparkles" style="width:16px;height:16px;"></i>
          Classifier
        </a>
        <a class="btn nav-link" href="/compare">Compare</a>
        <button class="btn-icon" id="themeBtn" type="button" aria-label="Toggle theme">
          <i data-lucide="moon" class="icon-dark" style="width:18px;height:18px;"></i>
          <i data-lucide="sun" class="icon-light hidden" style="width:18px;height:18px;"></i>
        </button>
      </div>
    </header>

    <p class="meta" id="meta">Loading models...</p>
    <div class="grid" id="cards"></div>
  </div>

  <script>
    (function() {
      const root = document.documentElement;
      const saved = localStorage.getItem('theme') || 'light';
      root.setAttribute('data-theme', saved);
    })();

    document.getElementById('themeBtn').addEventListener('click', () => {
      const root = document.documentElement;
      const next = root.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
      root.setAttribute('data-theme', next);
      localStorage.setItem('theme', next);
      document.querySelector('.icon-dark').classList.toggle('hidden', next === 'dark');
      document.querySelector('.icon-light').classList.toggle('hidden', next === 'light');
      lucide.createIcons();
    });

    lucide.createIcons();

    let _models = [];
    let _pollTimer = null;

    function warmBadge(m) {
      if (m.status === 'ready' || m.loaded) {
        return '<span class="badge badge-success"><i data-lucide="check-circle" style="width:11px;height:11px;vertical-align:-1px;"></i> Ready</span>';
      }
      if (m.status === 'loading') {
        return `<span class="badge badge-warning"><div class="spinner" style="width:10px;height:10px;border-width:1.5px;display:inline-block;vertical-align:-3px;margin-right:3px;"></div>${m.progress || 0}%</span>`;
      }
      if (m.status === 'error') {
        return '<span class="badge badge-error">Error</span>';
      }
      return '<span class="badge" style="background:var(--info-bg);color:var(--info-text);border:none;">Cold</span>';
    }

    function renderCard(m) {
      const isReady = m.status === 'ready' || m.loaded;
      const isLoading = m.status === 'loading';
      const progress = m.progress || 0;
      const msg = isLoading && m.message ? `<div style="font-size:0.72rem;color:var(--text-muted);margin-top:0.15rem;">${m.message}</div>` : '';
      const tasks = (m.tasks && m.tasks.length) ? `<div style="font-size:0.72rem;color:var(--text-muted);">Tasks: ${m.tasks.join(', ')}</div>` : '';
      return `
        <article class="model-card" data-id="${m.id}">
          <div class="model-card-head">
            <span class="model-title">${m.name}</span>
            <span class="badge-wrap">${warmBadge(m)}</span>
          </div>
          <div class="model-id">${m.id}</div>
          <div class="model-path">${m.path}</div>
          ${tasks}
          ${msg}
          <div class="progress-bar" style="margin-top:0.5rem;"><div class="progress-fill" style="width:${progress}%"></div></div>
          <div style="display:flex;gap:0.5rem;margin-top:auto;padding-top:0.5rem;">
            <a class="btn btn-primary" href="/models/${encodeURIComponent(m.id)}" style="flex:1;justify-content:center;">
              Open
            </a>
            ${isReady ? `<button class="btn btn-danger" data-unload="${m.id}" title="Unload from memory (frees RAM)"><i data-lucide="power" style="width:15px;height:15px;"></i></button>` : ''}
            ${(!isReady && !isLoading) ? `<button class="btn" data-preload="${m.id}" title="Pre-load into memory"><i data-lucide="zap" style="width:15px;height:15px;"></i></button>` : ''}
          </div>
        </article>
      `;
    }

    function bindCardButtons() {
      document.querySelectorAll('[data-preload]').forEach(btn => {
        btn.addEventListener('click', async () => {
          const id = btn.dataset.preload;
          btn.disabled = true;
          await fetch(`/api/models/${encodeURIComponent(id)}/preload`, { method: 'POST' });
          startPolling();
        });
      });
      document.querySelectorAll('[data-unload]').forEach(btn => {
        btn.addEventListener('click', async () => {
          const id = btn.dataset.unload;
          btn.disabled = true;
          await fetch(`/api/models/${encodeURIComponent(id)}/unload`, { method: 'POST' });
          await refreshAndRender();
        });
      });
    }

    function renderAllCards(models) {
      const cards = document.getElementById('cards');
      if (!models.length) {
        cards.innerHTML = '<div class="empty-card">No checkpoints discovered. Set MODEL_DIRS in .env.</div>';
      } else {
        cards.innerHTML = models.map(renderCard).join('');
      }
      lucide.createIcons();
      bindCardButtons();
    }

    function updateCardInPlace(m) {
      const card = document.querySelector(`.model-card[data-id="${m.id}"]`);
      if (!card) return;
      const wrap = card.querySelector('.badge-wrap');
      if (wrap) { wrap.innerHTML = warmBadge(m); lucide.createIcons(); }
      const fill = card.querySelector('.progress-fill');
      if (fill) fill.style.width = `${m.progress || 0}%`;
    }

    async function refreshAndRender() {
      const res = await fetch('/api/models');
      const data = await res.json();
      _models = data.models || [];
      document.getElementById('meta').textContent = `${_models.length} model(s) · Default: ${data.default_model_id || '-'}`;
      renderAllCards(_models);
      return _models;
    }

    function startPolling() {
      if (_pollTimer) return;
      _pollTimer = setInterval(async () => {
        const res = await fetch('/api/models');
        const data = await res.json();
        _models = data.models || [];
        const anyLoading = _models.some(m => m.status === 'loading');
        _models.forEach(updateCardInPlace);
        if (!anyLoading) {
          clearInterval(_pollTimer);
          _pollTimer = null;
          renderAllCards(_models); // full re-render to update buttons
        }
      }, 900);
    }

    async function loadModels() {
      const models = await refreshAndRender();
      if (models.some(m => m.status === 'loading')) startPolling();
    }

    loadModels().catch(err => {
      document.getElementById('meta').textContent = `Failed to load: ${err.message}`;
    });

    document.querySelector('.icon-dark').classList.toggle('hidden', document.documentElement.getAttribute('data-theme') === 'dark');
    document.querySelector('.icon-light').classList.toggle('hidden', document.documentElement.getAttribute('data-theme') === 'light');
  </script>
</body>
</html>
